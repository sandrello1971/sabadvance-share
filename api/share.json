{\rtf1\ansi\ansicpg1252\cocoartf2821
\cocoatextscaling0\cocoaplatform0{\fonttbl\f0\fswiss\fcharset0 Helvetica;}
{\colortbl;\red255\green255\blue255;}
{\*\expandedcolortbl;;}
\paperw11900\paperh16840\margl1440\margr1440\vieww11520\viewh8400\viewkind0
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural\partightenfactor0

\f0\fs24 \cf0 export default async function handler(req, res) \{\
  const slug = req.query.slug;\
  \
  if (!slug) \{\
    return res.status(400).send('Missing slug');\
  \}\
\
  const siteUrl = 'https://sabadvance.it';\
  const postUrl = `$\{siteUrl\}/blog/$\{slug\}`;\
  const defaultOgImage = `$\{siteUrl\}/lovable-uploads/9afc0cc7-085e-45e9-8a5d-eaccf88663b6.png`;\
\
  // Fetch post from Supabase\
  const supabaseUrl = process.env.SUPABASE_URL;\
  const supabaseKey = process.env.SUPABASE_ANON_KEY;\
\
  let title = 'Sabadvance';\
  let description = 'Leggi l\\'articolo completo su Sabadvance';\
  let ogImage = defaultOgImage;\
\
  try \{\
    const queryUrl = new URL(`$\{supabaseUrl\}/rest/v1/posts`);\
    queryUrl.searchParams.set('select', 'title,excerpt,featured_image');\
    queryUrl.searchParams.set('slug', `eq.$\{slug\}`);\
    queryUrl.searchParams.set('status', 'eq.published');\
    queryUrl.searchParams.set('limit', '1');\
\
    const response = await fetch(queryUrl.toString(), \{\
      headers: \{\
        apikey: supabaseKey,\
        authorization: `Bearer $\{supabaseKey\}`,\
      \},\
    \});\
\
    if (response.ok) \{\
      const posts = await response.json();\
      if (posts?.[0]) \{\
        title = posts[0].title;\
        description = posts[0].excerpt || `$\{title\} - Leggi l'articolo completo su Sabadvance`;\
        ogImage = posts[0].featured_image || defaultOgImage;\
      \}\
    \}\
  \} catch (e) \{\
    console.error('Error fetching post:', e);\
  \}\
\
  const escapeHtml = (str) => str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');\
\
  const html = `<!doctype html>\
<html lang="it">\
<head>\
  <meta charset="utf-8" />\
  <meta name="viewport" content="width=device-width,initial-scale=1" />\
  <title>$\{escapeHtml(title)\} | Sabadvance</title>\
  <meta name="description" content="$\{escapeHtml(description)\}" />\
  <meta property="og:title" content="$\{escapeHtml(title)\} | Sabadvance" />\
  <meta property="og:description" content="$\{escapeHtml(description)\}" />\
  <meta property="og:type" content="article" />\
  <meta property="og:url" content="$\{postUrl\}" />\
  <meta property="og:image" content="$\{ogImage\}" />\
  <meta property="og:image:width" content="1200" />\
  <meta property="og:image:height" content="630" />\
  <meta property="og:site_name" content="Sabadvance" />\
  <meta name="twitter:card" content="summary_large_image" />\
  <meta name="twitter:title" content="$\{escapeHtml(title)\} | Sabadvance" />\
  <meta name="twitter:description" content="$\{escapeHtml(description)\}" />\
  <meta name="twitter:image" content="$\{ogImage\}" />\
  <meta http-equiv="refresh" content="0;url=$\{postUrl\}" />\
  <script>window.location.replace("$\{postUrl\}");</script>\
</head>\
<body style="font-family:sans-serif;text-align:center;padding:50px;">\
  <h1>Reindirizzamento...</h1>\
  <p><a href="$\{postUrl\}">Clicca qui se non vieni reindirizzato</a></p>\
</body>\
</html>`;\
\
  res.setHeader('Content-Type', 'text/html; charset=utf-8');\
  res.setHeader('Cache-Control', 'public, max-age=3600');\
  return res.status(200).send(html);\
\}\
}